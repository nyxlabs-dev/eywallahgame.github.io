<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>NyxLabs | WAR: Touch Elite</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Rajdhani', 'Segoe UI', sans-serif;
            background-color: #050505;
            user-select: none;
            color: white;
            touch-action: none; /* Mobilde kaydÄ±rmayÄ± engelle */
        }

        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700;800&display=swap');

        /* --- UI GENEL --- */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .hidden { display: none !important; }
        
        /* Butonlar */
        .btn {
            background: linear-gradient(90deg, #0066ff, #0033aa);
            color: white; border: none; padding: 15px 40px;
            font-size: 22px; font-weight: bold; font-family: inherit;
            cursor: pointer; clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
            transition: 0.2s; text-transform: uppercase; letter-spacing: 2px;
            pointer-events: auto; box-shadow: 0 0 15px rgba(0, 100, 255, 0.5);
        }
        .btn:hover { background: linear-gradient(90deg, #0088ff, #0055cc); transform: scale(1.05); }
        .btn-secondary { background: #333; box-shadow: none; font-size: 18px; padding: 10px 30px; }

        /* --- DOKUNMATÄ°K KONTROLLER (Touch Controls) --- */
        .touch-interface {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: auto; z-index: 5;
        }

        /* Joystick AlanÄ± */
        #joystick-zone {
            position: absolute; bottom: 50px; left: 50px;
            width: 150px; height: 150px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            touch-action: none;
        }
        #joystick-nipple {
            position: absolute; top: 50%; left: 50%;
            width: 50px; height: 50px;
            background: rgba(0, 170, 255, 0.5);
            border: 2px solid #00aaff;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            box-shadow: 0 0 15px #00aaff;
        }

        /* BakÄ±ÅŸ AlanÄ± (SaÄŸ taraf) */
        #look-zone {
            position: absolute; top: 0; right: 0;
            width: 60%; height: 100%;
            touch-action: none;
            /* background: rgba(255,0,0,0.1); Debug iÃ§in aÃ§Ä±labilir */ 
        }

        /* Aksiyon ButonlarÄ± */
        .action-btn {
            position: absolute;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            color: white;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 18px;
            cursor: pointer; touch-action: none;
            transition: transform 0.1s;
            backdrop-filter: blur(4px);
        }
        .action-btn:active { transform: scale(0.9); background: rgba(255, 255, 255, 0.2); }

        #btn-fire {
            bottom: 60px; right: 40px;
            width: 90px; height: 90px;
            background: rgba(255, 50, 50, 0.3);
            border-color: rgba(255, 50, 50, 0.6);
            font-size: 24px;
        }
        #btn-fire:active { background: rgba(255, 50, 50, 0.6); box-shadow: 0 0 20px red; }

        #btn-reload { bottom: 170px; right: 50px; width: 60px; height: 60px; }
        #btn-jump { bottom: 60px; right: 150px; width: 70px; height: 70px; }
        #btn-scope { bottom: 160px; right: 140px; width: 60px; height: 60px; }
        #btn-switch { top: 120px; right: 20px; width: 70px; height: 70px; border-radius: 10px; font-size: 14px; text-align: center; }

        /* --- LOBÄ° EKRANI --- */
        #lobby-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 50% 50%, #1a202c 0%, #000000 100%);
            display: flex; flex-direction: row;
            z-index: 20; pointer-events: auto;
        }
        #lobby-left {
            width: 45%; height: 100%; padding: 40px; box-sizing: border-box;
            display: flex; flex-direction: column; justify-content: center;
            background: linear-gradient(90deg, rgba(0,0,0,0.9) 0%, transparent 100%);
        }
        #lobby-right { flex: 1; position: relative; }
        
        .game-title {
            font-size: 60px; font-weight: 900; line-height: 1; margin-bottom: 10px;
            background: linear-gradient(to right, #fff, #00aaff); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .game-subtitle { font-size: 20px; color: #8899aa; letter-spacing: 5px; margin-bottom: 40px; }
        .lobby-stats { margin-bottom: 30px; font-size: 18px; color: #ffd700; display: flex; align-items: center; gap: 15px; }
        .lobby-menu { display: flex; flex-direction: column; gap: 15px; align-items: flex-start; }

        /* --- MARKET --- */
        #market-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 85%; height: 85%; background: rgba(10, 15, 20, 0.98);
            border: 1px solid #333; border-radius: 10px; padding: 20px;
            display: none; flex-direction: column; z-index: 30;
        }
        .market-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; overflow-y: auto; flex: 1; }
        .market-item {
            background: rgba(255,255,255,0.05); border: 1px solid #333; padding: 15px;
            border-radius: 5px; text-align: center; cursor: pointer; transition: 0.2s;
        }
        .market-item:hover { border-color: #00aaff; background: rgba(0, 170, 255, 0.1); }
        .market-item.owned { border-color: #00ff88; }
        
        /* --- HUD --- */
        #score-panel {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            display: flex; align-items: center; pointer-events: none;
            background: rgba(10, 15, 20, 0.8); border: 1px solid rgba(255,255,255,0.1);
            padding: 5px 30px; border-radius: 30px; backdrop-filter: blur(5px);
        }
        .score-box { font-size: 28px; font-weight: bold; padding: 0 15px; }
        .score-blue { color: #4da6ff; border-right: 1px solid #555; }
        .score-red { color: #ff4d4d; border-left: 1px solid #555; }
        .score-target { font-size: 12px; color: #888; padding: 0 15px; text-align: center; }

        #weapon-hud { position: absolute; top: 20px; right: 20px; text-align: right; pointer-events: none; }
        .weapon-name { font-size: 24px; font-weight: 900; color: white; font-style: italic; }
        .ammo-text { font-size: 32px; font-weight: bold; color: #00aaff; }
        
        #player-status { position: absolute; top: 20px; left: 20px; pointer-events: none; }
        .hp-bar-bg { width: 200px; height: 10px; background: #333; margin-top: 5px; border-radius: 5px; overflow: hidden; }
        .hp-bar-fill { width: 100%; height: 100%; background: #00ff88; transition: width 0.2s; }

        #crosshair {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 24px; height: 24px; pointer-events: none;
        }
        .ch-line { position: absolute; background: rgba(0,255,0,0.8); }
        .ch-h { width: 100%; height: 2px; top: 11px; }
        .ch-v { height: 100%; width: 2px; left: 11px; }
        
        #hit-marker {
            position: absolute; top: 50%; left: 50%; width: 30px; height: 30px;
            border: 2px solid red; transform: translate(-50%, -50%) rotate(45deg);
            opacity: 0; transition: opacity 0.1s; pointer-events: none;
        }

        #notification-area { position: absolute; top: 100px; left: 50%; transform: translateX(-50%); display: flex; flex-direction: column; gap: 5px; align-items: center; pointer-events: none; }
        .notif { background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 4px; border-bottom: 2px solid white; animation: fade 3s forwards; font-size: 14px; }
        @keyframes fade { 0% { opacity:1; transform: translateY(10px); } 100% { opacity:0; transform: translateY(0); } }

        /* Oyun Sonu */
        #game-over-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 50; display: none;
            flex-direction: column; justify-content: center; align-items: center;
            pointer-events: auto;
        }

    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <!-- LOBÄ° EKRANI -->
    <div id="lobby-screen">
        <div id="lobby-left">
            <div class="game-title">NYXLABS<br>WAR</div>
            <div class="game-subtitle">TOUCH ELITE</div>
            
            <div class="lobby-stats">
                <span>ðŸ’° BAKÄ°YE: <span id="lobby-money">0</span> NC</span>
            </div>

            <div class="lobby-menu">
                <button class="btn" onclick="startGame()">OPERASYONA BAÅžLA</button>
                <button class="btn btn-secondary" onclick="toggleMarket(true)">SÄ°LAH MARKETÄ°</button>
            </div>
            
            <div style="margin-top: 40px; color: #666; font-size: 12px; line-height: 1.5;">
                <strong style="color:#00aaff">KONTROLLER:</strong><br>
                SOL ALT: Hareket (Joystick)<br>
                SAÄž EKRAN: NiÅŸan (SÃ¼rÃ¼kle)<br>
                SAÄž ALT: AteÅŸ & Aksiyonlar
            </div>
        </div>
        <div id="lobby-right"></div>
    </div>

    <!-- MARKET -->
    <div id="market-overlay">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h2 style="margin:0;">SÄ°LAH MARKETÄ°</h2>
            <button class="btn btn-secondary" style="padding: 5px 20px;" onclick="toggleMarket(false)">KAPAT</button>
        </div>
        <div class="market-grid" id="market-grid"></div>
    </div>

    <!-- OYUN SONU -->
    <div id="game-over-screen">
        <h1 id="end-title" style="font-size: 60px; margin-bottom: 20px;">OYUN BÄ°TTÄ°</h1>
        <div style="font-size: 24px; color: #ffd700; margin-bottom: 40px;">KAZANILAN: <span id="end-reward">0</span> NC</div>
        <button class="btn" onclick="location.reload()">LOBÄ°YE DÃ–N</button>
    </div>

    <!-- OYUN HUD & DOKUNMATÄ°K KONTROLLER -->
    <div id="ui-layer">
        <div id="score-panel">
            <span class="score-box score-blue" id="score-blue">0</span>
            <div class="score-target">HEDEF<br>100</div>
            <span class="score-box score-red" id="score-red">0</span>
        </div>

        <div id="player-status">
            <div style="font-weight: bold; font-size: 20px;">OPERATOR</div>
            <div class="hp-bar-bg"><div class="hp-bar-fill" id="hud-hp"></div></div>
        </div>

        <div id="weapon-hud">
            <div class="weapon-name" id="hud-wep-name">RIFLE</div>
            <div class="ammo-text"><span id="hud-ammo">30</span></div>
        </div>

        <div id="crosshair">
            <div class="ch-line ch-h"></div>
            <div class="ch-line ch-v"></div>
        </div>
        <div id="hit-marker"></div>
        <div id="notification-area"></div>

        <!-- DOKUNMATÄ°K ARAYÃœZ (Touch Interface) -->
        <div class="touch-interface" id="touch-controls">
            <!-- Joystick -->
            <div id="joystick-zone">
                <div id="joystick-nipple"></div>
            </div>

            <!-- BakÄ±ÅŸ AlanÄ± (GÃ¶rÃ¼nmez, saÄŸ yarÄ±yÄ± kaplar) -->
            <div id="look-zone"></div>

            <!-- Butonlar -->
            <div class="action-btn" id="btn-switch">SÄ°LAH</div>
            <div class="action-btn" id="btn-scope">ZOOM</div>
            <div class="action-btn" id="btn-reload">R</div>
            <div class="action-btn" id="btn-jump">ZIPLA</div>
            <div class="action-btn" id="btn-fire">ATEÅž</div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';

        // --- AYARLAR ---
        const CONFIG = {
            WIN_SCORE: 100,
            PLAYER_SPEED: 18,
            SENSITIVITY_X: 0.004,
            SENSITIVITY_Y: 0.004,
            GRAVITY: 300,
            JUMP_HEIGHT: 120,
            BOT_COUNT: 10
        };

        const WEAPONS = [
            { id: 'm4', name: 'M4A1', type: 'primary', price: 0, dmg: 22, rate: 0.1, mag: 30, color: 0x333333 },
            { id: 'ak47', name: 'AK-47', type: 'primary', price: 500, dmg: 28, rate: 0.12, mag: 30, color: 0x553311 },
            { id: 'awp', name: 'AWP', type: 'primary', price: 1500, dmg: 105, rate: 1.5, mag: 5, color: 0x224422 },
            { id: 'glock', name: 'GLOCK', type: 'secondary', price: 0, dmg: 15, rate: 0.2, mag: 15, color: 0x111111 }
        ];

        // --- DEÄžÄ°ÅžKENLER ---
        let gameState = 'LOBBY';
        let userData = { money: 0, inventory: ['m4', 'glock'], loadout: { primary: 'm4', secondary: 'glock' } };
        
        let scene, camera, renderer;
        let clock = new THREE.Clock();
        let raycaster = new THREE.Raycaster();
        
        // Input States (Dokunmatik & Mouse)
        let input = {
            move: { x: 0, y: 0 }, // Joystick -1 to 1
            look: { x: 0, y: 0 }, // Look delta
            fire: false,
            scope: false
        };

        let player = { hp: 100, ammo: 30, curWepIdx: 0, weapons: [], velocity: new THREE.Vector3(), canJump: false };
        let bots = [];
        let projectiles = [];
        let worldObjects = [];
        let weaponModel = null;
        let scores = { blue: 0, red: 0 };

        // Joystick Logic Variables
        let joyData = { active: false, startX: 0, startY: 0, curX: 0, curY: 0, radius: 75 };

        // --- BAÅžLANGIÃ‡ ---
        init();
        animate();

        function init() {
            loadData();
            setupThreeJS();
            setupLobby();
            setupTouchControls();
            
            // Market UI
            renderMarket();
            document.getElementById('lobby-money').innerText = userData.money;
        }

        function loadData() {
            const saved = localStorage.getItem('nyx_war_save_touch');
            if(saved) userData = JSON.parse(saved);
        }
        function saveData() {
            localStorage.setItem('nyx_war_save_touch', JSON.stringify(userData));
            document.getElementById('lobby-money').innerText = userData.money;
            renderMarket();
        }

        function setupThreeJS() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a1015);
            scene.fog = new THREE.FogExp2(0x0a1015, 0.0015);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            // IÅŸÄ±klar
            const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 0.6);
            scene.add(hemi);
            const dir = new THREE.DirectionalLight(0xffffff, 0.8);
            dir.position.set(50, 200, 50);
            dir.castShadow = true;
            dir.shadow.mapSize.set(2048, 2048);
            scene.add(dir);

            window.addEventListener('resize', onWindowResize);
        }

        function setupLobby() {
            camera.position.set(0, 1.8, 4);
            camera.rotation.set(0,0,0);
            
            // Lobi AvatarÄ±
            const avatar = new THREE.Group();
            const body = new THREE.Mesh(new THREE.CapsuleGeometry(0.5, 1.8), new THREE.MeshStandardMaterial({ color: 0x0088ff }));
            body.position.y = 0.9;
            const head = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.4, 0.4), new THREE.MeshStandardMaterial({ color: 0x333 }));
            head.position.set(0, 1.6, 0.3);
            
            // Silah
            const gun = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.2, 0.8), new THREE.MeshStandardMaterial({ color: 0x222 }));
            gun.position.set(0.3, 1.3, 0.5);
            
            avatar.add(body, head, gun);
            avatar.userData.isLobby = true;
            scene.add(avatar);
        }

        // --- OYUN BAÅžLATMA ---
        window.startGame = function() {
            document.getElementById('lobby-screen').style.display = 'none';
            document.getElementById('ui-layer').style.display = 'block';
            
            // Lobi objelerini temizle
            scene.children.forEach(c => { if(c.userData.isLobby) c.visible = false; });

            createGameWorld();
            
            player.hp = 100;
            player.curWepIdx = 0;
            player.weapons = [
                WEAPONS.find(w => w.id === userData.loadout.primary),
                WEAPONS.find(w => w.id === userData.loadout.secondary)
            ];
            equipWeapon(0);
            
            // Spawn
            camera.position.set(0, 20, 0);
            camera.rotation.set(0,0,0); // Reset rot
            
            gameState = 'GAME';
            
            // Botlar
            bots = [];
            for(let i=0; i<CONFIG.BOT_COUNT; i++) spawnBot(i%2===0 ? 'blue' : 'red');
        };

        function createGameWorld() {
            worldObjects = [];
            // Zemin
            const geo = new THREE.PlaneGeometry(500, 500, 32, 32);
            geo.rotateX(-Math.PI / 2);
            const pos = geo.attributes.position;
            for(let i=0; i<pos.count; i++){
                const x = pos.getX(i); const z = pos.getZ(i);
                pos.setY(i, Math.sin(x*0.05)*Math.cos(z*0.05)*5); // Engebe
            }
            geo.computeVertexNormals();
            const terrain = new THREE.Mesh(geo, new THREE.MeshStandardMaterial({ color: 0x1a1a1a, roughness: 0.9 }));
            terrain.receiveShadow = true;
            scene.add(terrain);
            worldObjects.push(terrain);

            // Kutular
            const boxGeo = new THREE.BoxGeometry(1,1,1);
            const boxMat = new THREE.MeshStandardMaterial({ color: 0x444 });
            for(let i=0; i<40; i++){
                const box = new THREE.Mesh(boxGeo, boxMat);
                const s = 3 + Math.random()*5;
                box.scale.set(s,s,s);
                box.position.set((Math.random()-0.5)*400, s/2, (Math.random()-0.5)*400);
                box.castShadow = true; box.receiveShadow = true;
                scene.add(box);
                worldObjects.push(box);
            }
        }

        // --- TOUCH KONTROLLERÄ° (JOYSTICK & LOOK & BUTTONS) ---
        function setupTouchControls() {
            const joyZone = document.getElementById('joystick-zone');
            const joyNipple = document.getElementById('joystick-nipple');
            const lookZone = document.getElementById('look-zone');

            // --- JOYSTICK ---
            const handleJoyStart = (clientX, clientY) => {
                const rect = joyZone.getBoundingClientRect();
                const centerX = rect.left + rect.width/2;
                const centerY = rect.top + rect.height/2;
                joyData.active = true;
                joyData.startX = centerX;
                joyData.startY = centerY;
                updateJoy(clientX, clientY);
            };

            const updateJoy = (clientX, clientY) => {
                if(!joyData.active) return;
                let dx = clientX - joyData.startX;
                let dy = clientY - joyData.startY;
                const dist = Math.sqrt(dx*dx + dy*dy);
                
                if(dist > joyData.radius) {
                    const ratio = joyData.radius / dist;
                    dx *= ratio; dy *= ratio;
                }
                
                joyNipple.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
                
                // Input'a aktar (-1 to 1)
                input.move.x = dx / joyData.radius;
                input.move.y = dy / joyData.radius;
            };

            const resetJoy = () => {
                joyData.active = false;
                joyNipple.style.transform = `translate(-50%, -50%)`;
                input.move.x = 0; input.move.y = 0;
            };

            // Touch Events (Joystick)
            joyZone.addEventListener('touchstart', e => handleJoyStart(e.touches[0].clientX, e.touches[0].clientY));
            joyZone.addEventListener('touchmove', e => updateJoy(e.touches[0].clientX, e.touches[0].clientY));
            joyZone.addEventListener('touchend', resetJoy);
            
            // Mouse Events (Joystick - PC iÃ§in)
            joyZone.addEventListener('mousedown', e => handleJoyStart(e.clientX, e.clientY));
            window.addEventListener('mousemove', e => { if(joyData.active) updateJoy(e.clientX, e.clientY); });
            window.addEventListener('mouseup', resetJoy);

            // --- LOOK (KAMERA) ---
            let lastLookX = 0, lastLookY = 0;
            
            const handleLookStart = (x, y) => { lastLookX = x; lastLookY = y; };
            const handleLookMove = (x, y) => {
                const dx = x - lastLookX;
                const dy = y - lastLookY;
                
                // Rotasyon Uygula (YXZ sÄ±rasÄ± Ã¶nemli)
                // Yaw (Y ekseni etrafÄ±nda dÃ¶nme - SaÄŸa/Sola)
                camera.rotation.y -= dx * CONFIG.SENSITIVITY_X;
                
                // Pitch (X ekseni etrafÄ±nda dÃ¶nme - YukarÄ±/AÅŸaÄŸÄ±) - Clamp ile sÄ±nÄ±rla
                const newX = camera.rotation.x - dy * CONFIG.SENSITIVITY_Y;
                camera.rotation.x = Math.max(-1.5, Math.min(1.5, newX)); // ~90 derece sÄ±nÄ±r

                lastLookX = x; lastLookY = y;
            };

            lookZone.addEventListener('touchstart', e => handleLookStart(e.touches[0].clientX, e.touches[0].clientY));
            lookZone.addEventListener('touchmove', e => { e.preventDefault(); handleLookMove(e.touches[0].clientX, e.touches[0].clientY); });
            
            // Mouse Look (PC iÃ§in sÃ¼rÃ¼kle-bak)
            let isLooking = false;
            lookZone.addEventListener('mousedown', e => { isLooking = true; handleLookStart(e.clientX, e.clientY); });
            window.addEventListener('mousemove', e => { if(isLooking) handleLookMove(e.clientX, e.clientY); });
            window.addEventListener('mouseup', () => isLooking = false);

            // --- BUTONLAR ---
            const btnFire = document.getElementById('btn-fire');
            const startFire = (e) => { e.preventDefault(); input.fire = true; };
            const endFire = (e) => { e.preventDefault(); input.fire = false; };
            btnFire.addEventListener('touchstart', startFire); btnFire.addEventListener('touchend', endFire);
            btnFire.addEventListener('mousedown', startFire); btnFire.addEventListener('mouseup', endFire);

            document.getElementById('btn-jump').onmousedown = () => { if(player.canJump) { player.velocity.y = CONFIG.JUMP_HEIGHT; player.canJump = false; } };
            document.getElementById('btn-jump').ontouchstart = (e) => { e.preventDefault(); if(player.canJump) { player.velocity.y = CONFIG.JUMP_HEIGHT; player.canJump = false; } };

            document.getElementById('btn-reload').onclick = reload;
            document.getElementById('btn-scope').onclick = toggleScope;
            document.getElementById('btn-switch').onclick = () => equipWeapon(player.curWepIdx === 0 ? 1 : 0);
        }

        // --- OYUN MANTIÄžI ---
        function animate() {
            requestAnimationFrame(animate);
            const delta = Math.min(clock.getDelta(), 0.1);

            if (gameState === 'LOBBY') {
                // Lobi avatarÄ±nÄ± dÃ¶ndÃ¼r
                scene.children.forEach(c => { if(c.userData.isLobby) c.rotation.y += delta * 0.5; });
                renderer.render(scene, camera);
                return;
            }

            if (gameState === 'GAME') {
                // 1. Oyuncu Hareketi (Joystick'ten gelen input.move.x/y)
                // KameranÄ±n yÃ¶nÃ¼ne gÃ¶re hareket vektÃ¶rÃ¼nÃ¼ hesapla
                const camDir = new THREE.Vector3();
                camera.getWorldDirection(camDir);
                const forward = new THREE.Vector3(camDir.x, 0, camDir.z).normalize();
                const right = new THREE.Vector3().crossVectors(new THREE.Vector3(0,1,0), forward).normalize(); // Sol aslÄ±nda ama tersleyebiliriz

                // Input: y ileri (-), x saÄŸ (+)
                // Joystick yukarÄ± (-y) -> Ä°leri gitmeli
                const moveVec = new THREE.Vector3();
                if (Math.abs(input.move.y) > 0.1) moveVec.add(forward.multiplyScalar(-input.move.y));
                if (Math.abs(input.move.x) > 0.1) moveVec.add(right.multiplyScalar(-input.move.x)); // SaÄŸ/Sol dÃ¼zeltmesi

                const speed = CONFIG.PLAYER_SPEED;
                player.velocity.x = moveVec.x * speed;
                player.velocity.z = moveVec.z * speed;
                
                // YerÃ§ekimi
                player.velocity.y -= CONFIG.GRAVITY * delta;

                // Uygula
                camera.position.x += player.velocity.x * delta;
                camera.position.z += player.velocity.z * delta;
                camera.position.y += player.velocity.y * delta;

                // Zemin KontrolÃ¼ (Basit Arazi)
                const terrainH = getTerrainY(camera.position.x, camera.position.z);
                if (camera.position.y < terrainH + 4) {
                    camera.position.y = terrainH + 4;
                    player.velocity.y = 0;
                    player.canJump = true;
                }

                // Silah Takibi (Kameraya yumuÅŸak baÄŸlanma)
                if(weaponModel) {
                    // SilahÄ± kameranÄ±n Ã¶nÃ¼ne koy ama rotasyonu kameradan al
                    const gunPos = camera.position.clone();
                    const gunOffset = new THREE.Vector3(0.5, -0.6, -1.2); // SaÄŸ alt
                    gunOffset.applyEuler(camera.rotation);
                    gunPos.add(gunOffset);
                    
                    weaponModel.position.lerp(gunPos, 0.5); // Lag efekti
                    weaponModel.rotation.copy(camera.rotation);
                    
                    // Recoil recovery
                    if(weaponModel.userData.recoil > 0) {
                        weaponModel.rotateX(weaponModel.userData.recoil);
                        weaponModel.userData.recoil -= delta * 2;
                    }
                }

                // AteÅŸ KontrolÃ¼ (BasÄ±lÄ± tutma)
                if (input.fire) attemptShoot(true);

                updateProjectiles(delta);
                updateBots(delta);
            }

            renderer.render(scene, camera);
        }

        function getTerrainY(x, z) {
            return Math.sin(x*0.05)*Math.cos(z*0.05)*5; // Basit terrain formÃ¼lÃ¼
        }

        // --- BOT & SAVAÅž ---
        function spawnBot(team) {
            const color = team === 'blue' ? 0x0088ff : 0xff3333;
            const mesh = new THREE.Group();
            
            const body = new THREE.Mesh(new THREE.CapsuleGeometry(1, 3), new THREE.MeshStandardMaterial({ color: color }));
            body.position.y = 1.5;
            
            const head = new THREE.Mesh(new THREE.BoxGeometry(0.8,0.8,0.8), new THREE.MeshStandardMaterial({ color: 0x222 }));
            head.position.y = 3.2;
            head.userData = { isHead: true };

            // HP Bar Mesh
            const hpGeo = new THREE.PlaneGeometry(1.5, 0.2);
            const hpMat = new THREE.MeshBasicMaterial({ color: 0x00ff00, side: THREE.DoubleSide });
            const hpMesh = new THREE.Mesh(hpGeo, hpMat);
            hpMesh.position.y = 4.2;

            mesh.add(body, head, hpMesh);
            
            const x = (Math.random()-0.5)*400;
            const z = (Math.random()-0.5)*400;
            mesh.position.set(x, getTerrainY(x,z)+3, z);
            
            scene.add(mesh);
            bots.push({ mesh, hpMesh, team, hp: 100, alive: true, nextShot: 0 });
        }

        function updateBots(delta) {
            const pPos = camera.position;
            bots.forEach(b => {
                if(!b.alive) return;
                
                b.hpMesh.lookAt(pPos);
                
                // Basit AI
                const dist = b.mesh.position.distanceTo(pPos);
                if(dist > 20) {
                    b.mesh.lookAt(pPos.x, b.mesh.position.y, pPos.z);
                    b.mesh.translateZ(10 * delta);
                }
                
                // YerÃ§ekimi/Zemin
                const ty = getTerrainY(b.mesh.position.x, b.mesh.position.z);
                b.mesh.position.y = ty;

                // AteÅŸ
                if(Date.now() > b.nextShot && dist < 100) {
                    shoot(b, false);
                    b.nextShot = Date.now() + 1500 + Math.random()*1000;
                }
            });
        }

        function equipWeapon(idx) {
            player.curWepIdx = idx;
            const wep = player.weapons[idx];
            player.ammo = wep.mag;
            
            if(weaponModel) scene.remove(weaponModel);
            
            // Basit Silah Modeli
            const g = new THREE.Group();
            const mat = new THREE.MeshStandardMaterial({ color: wep.color });
            const body = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.3, 1), mat);
            g.add(body);
            g.userData = { recoil: 0 };
            
            weaponModel = g;
            scene.add(g); // Sahneye ekliyoruz, animate iÃ§inde kamerayÄ± takip ettireceÄŸiz
            
            document.getElementById('hud-wep-name').innerText = wep.name;
            updateHUD();
        }

        let lastShotTime = 0;
        function attemptShoot(isPlayer) {
            const now = Date.now() / 1000;
            const wep = player.weapons[player.curWepIdx];
            
            if(now - lastShotTime < wep.rate) return;
            if(player.ammo <= 0) { reload(); return; }
            
            lastShotTime = now;
            player.ammo--;
            updateHUD();
            
            shoot(null, true);
            
            // GÃ¶rsel efekt
            if(weaponModel) weaponModel.userData.recoil = 0.1;
        }

        function shoot(shooter, isPlayer) {
            let startPos, dir;
            
            if(isPlayer) {
                // Kamera yÃ¶nÃ¼nde
                startPos = camera.position.clone();
                // SilahÄ±n ucundan Ã§Ä±ksÄ±n (biraz saÄŸ alt)
                const offset = new THREE.Vector3(0.5, -0.5, -1).applyEuler(camera.rotation);
                startPos.add(offset);
                
                dir = new THREE.Vector3();
                camera.getWorldDirection(dir);
            } else {
                startPos = shooter.mesh.position.clone().add(new THREE.Vector3(0,2,0));
                dir = new THREE.Vector3(0,0,1).applyQuaternion(shooter.mesh.quaternion);
            }

            const ball = new THREE.Mesh(new THREE.SphereGeometry(0.2), new THREE.MeshBasicMaterial({ color: isPlayer ? 0xffff00 : 0xff0000 }));
            ball.position.copy(startPos);
            scene.add(ball);

            projectiles.push({
                mesh: ball,
                vel: dir.multiplyScalar(100),
                owner: isPlayer ? 'player' : 'bot',
                team: isPlayer ? 'blue' : shooter.team,
                life: 2,
                dmg: isPlayer ? player.weapons[player.curWepIdx].dmg : 10
            });
        }

        function updateProjectiles(delta) {
            // Raycaster'a kamera ata (Sprite hatasÄ±nÄ± Ã¶nlemek iÃ§in)
            raycaster.camera = camera;

            for(let i=projectiles.length-1; i>=0; i--) {
                const p = projectiles[i];
                p.life -= delta;
                if(p.life <= 0) { scene.remove(p.mesh); projectiles.splice(i,1); continue; }

                const prev = p.mesh.position.clone();
                p.mesh.position.add(p.vel.clone().multiplyScalar(delta));

                // Raycast
                const dir = p.vel.clone().normalize();
                const dist = p.mesh.position.distanceTo(prev);
                raycaster.set(prev, dir);
                
                // Hedefler
                const targets = [];
                bots.forEach(b => { if(b.alive && b.team !== p.team) targets.push(b.mesh); });
                
                // Basit Player Hit
                if(p.owner !== 'player' && p.mesh.position.distanceTo(camera.position) < 2) {
                    player.hp -= 10;
                    updateHUD();
                    scene.remove(p.mesh); projectiles.splice(i,1);
                    if(player.hp <= 0) { alert("Ã–LDÃœN!"); location.reload(); }
                    continue;
                }

                const hits = raycaster.intersectObjects(targets, true);
                if(hits.length > 0 && hits[0].distance < dist) {
                    const hitObj = hits[0].object;
                    // Parent'Ä± bul
                    let bot = bots.find(b => b.mesh === hitObj || b.mesh === hitObj.parent);
                    
                    if(bot) {
                        let dmg = p.dmg;
                        if(hitObj.userData.isHead) dmg *= 2; // Headshot
                        
                        bot.hp -= dmg;
                        bot.hpMesh.scale.x = Math.max(0, bot.hp/100);
                        
                        if(p.owner === 'player') {
                            const marker = document.getElementById('hit-marker');
                            marker.style.opacity = 1;
                            setTimeout(()=>marker.style.opacity=0, 100);
                        }

                        if(bot.hp <= 0) {
                            bot.alive = false;
                            bot.mesh.visible = false;
                            if(bot.team === 'red') {
                                scores.blue++;
                                userData.money += 20;
                                saveData();
                            } else scores.red++;
                            
                            document.getElementById('score-blue').innerText = scores.blue;
                            document.getElementById('score-red').innerText = scores.red;
                            
                            addNotif("DÃœÅžMAN Ä°NDÄ°RÄ°LDÄ°");
                            
                            if(scores.blue >= CONFIG.WIN_SCORE) {
                                document.getElementById('game-over-screen').style.display = 'flex';
                                document.getElementById('end-reward').innerText = "500";
                                userData.money += 500; saveData();
                            }

                            setTimeout(() => {
                                bot.alive = true; bot.hp = 100; bot.mesh.visible = true;
                                const x = (Math.random()-0.5)*400;
                                const z = (Math.random()-0.5)*400;
                                bot.mesh.position.set(x, getTerrainY(x,z)+3, z);
                                bot.hpMesh.scale.x = 1;
                            }, 3000);
                        }
                    }
                    scene.remove(p.mesh); projectiles.splice(i,1);
                }
            }
        }

        // --- UI UTILS ---
        window.toggleMarket = (show) => document.getElementById('market-overlay').style.display = show ? 'flex' : 'none';
        
        function renderMarket() {
            const grid = document.getElementById('market-grid');
            grid.innerHTML = '';
            WEAPONS.forEach(w => {
                if(w.type==='secondary') return;
                const div = document.createElement('div');
                const owned = userData.inventory.includes(w.id);
                div.className = `market-item ${owned?'owned':''}`;
                div.innerHTML = `<h3>${w.name}</h3><p>Hasar: ${w.dmg}</p><p>${owned?'SAHÄ°PSÄ°N':w.price+' NC'}</p>`;
                div.onclick = () => {
                    if(!owned && userData.money >= w.price) {
                        userData.money -= w.price;
                        userData.inventory.push(w.id);
                        saveData();
                    } else if(owned) {
                        userData.loadout.primary = w.id;
                        saveData();
                        alert("KuÅŸanÄ±ldÄ±: " + w.name);
                    }
                };
                grid.appendChild(div);
            });
        }

        function reload() { player.ammo = player.weapons[player.curWepIdx].mag; updateHUD(); }
        function toggleScope() {
            input.scope = !input.scope;
            camera.fov = input.scope ? 30 : 75;
            camera.updateProjectionMatrix();
        }
        function updateHUD() {
            document.getElementById('hud-ammo').innerText = player.ammo;
            document.getElementById('hud-hp').style.width = player.hp + '%';
        }
        function addNotif(text) {
            const d = document.createElement('div'); d.className = 'notif'; d.innerText = text;
            document.getElementById('notification-area').appendChild(d);
            setTimeout(()=>d.remove(), 3000);
        }
        function onWindowResize() {
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

    </script>
</body>
</html>
